{% extends "base_generic.html" %}
{% load staticfiles %}

{% block styles %}
<style>
.link {
  stroke: #000;
  stroke-width: 1.5px;
}

{% comment %}
.node {
  cursor: move;
  fill: #ccc;
  stroke: #000;
  stroke-width: 1.5px;
}
{% endcomment %}

.node.fixed {
    //stroke: #f00;
    stroke-width: 1.0px;
}

text {
  fill: #000;
  font: 12px times;
  pointer-events: none;
}

path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

.open_img {
    background-image: url("{% static "browser/img/details_open.png" %}");
{#    width: 10px;#}
    background-repeat: no-repeat;
    padding-left: 22px;  /* width of the image plus a little extra padding */
    cursor: pointer;
    padding-bottom: 3px;
}
.close_img {
    background-image: url("{% static "browser/img/details_close.png" %}");
    background-repeat: no-repeat;
    padding-left: 22px;  /* width of the image plus a little extra padding */
    cursor: pointer;
    padding-bottom: 3px;
}

</style>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>

        var neg_search_num=200

        //add tooltip to concept counts showing concepts


        //$(function() {
        //    $( ".concept" ).tooltip({
        //        content: function(event, ui) { return $(this).attr('title'); },
        //    });
        //});

        function share_result(resID,status){
            console.log(status+' sharing '+resID)
            $.ajax({
                url: "{% url 'ajax_share' %}",
                "data": {
                    resID : resID,
                    status: status,
                },
                type: 'get', // This is the default though, you don't actually need to always mention it
                success: function(data) {
                    show_share_button(status)
                },
                failure: function(data) {
                    alert('Got an error dude');
                }
            });
        }

        function show_share_button(status){
            userStatus = '{{ userStatus }}'
            //console.log('userStatus = '+userStatus)
            //console.log('show_share_button status = '+status)
            if (status == 'False') {
                console.log('updating button to not share')
                document.getElementById('share_yes').style.display = 'none';
                document.getElementById('share_no').style.display = 'block';
            } else if (userStatus != 'guest'){
                console.log('updating button to share')
                document.getElementById('share_yes').style.display = 'block';
                document.getElementById('share_no').style.display = 'none';
            }
        }

        function concept_div(key){
            $('#'+key).toggle();
            var c = $('#'+key+'_header').attr('class')
            if (c == "open_img") {
                $('#' + key + '_header').attr('class','close_img')
            }else {
                $('#' + key + '_header').attr('class','open_img')
            }
        }

        //function to add filter to table
        function tFilter(w){
            //console.log("searching for "+w)
            oTable = $('#resAll').dataTable();
            oTable.fnFilter( w );
            //g=oTable.fnFilter.val()
            //console.log(g)
        }

        function topHits(t){
            oTable = $('#resAll').dataTable();
            oTable.fnSetDisplayLength = t;
            oTable.fnDraw();
        }

        $(document).ready(function () {

            // Instance the tour for the button
			var tour = new Tour({
                backdrop: true,
                backdropPadding: 5,
                onEnd: function(tour){$('.nav-tabs a[href="#home"]').tab('show');},
			  steps: [
                  {
			    element: "#plots",
                      onShow: function(tour){$('.nav-tabs a[href="#graph_div"]').tab('show');},
			    title: "Graph View",
			    content: "A graph view displaying the top "+$("#maxTop").val()+" enriched shared SemMed triplets and the relationships between the two article sets. The thickness of the lines represents the number of" +
                "articles containing the enriched term",
			    placement: "bottom"

			  },
			   {
			    element: "#plots",
                   onShow: function(tour){$('.nav-tabs a[href="#sankey_div"]').tab('show');},
			    title: "Sankey Plot",
			    content: "A Sankey plot displaying the top enriched shared SemMed triplets and the links between the two search sets",
			    placement: "bottom"

			  },
                  {
			    element: "#p",
			    title: "Max Mean Corrected P-Value Filter",
			    content: "Filter the results by the maximum mean corrected P-Value for the enrichment analysis across both search sets",
			    placement: "right"

			  },
                  {
			    element: "#o",
			    title: "Min Mean Odds Ratio Filter",
			    content: "Filter the results by the minimum mean odds ratio for the enrichment analysis across both search sets",
			    placement: "right"

			  },
                  {
			    element: "#m",
			    title: "Min Predicate Frequency Rank",
			    content: "Each of the SemMedDB predicates (the linking term) has a frequency value, calculated using the entire data set. Predicates with high frequency, such as 'ISA' and 'PART_OF' are often highly frequent and " +
                "perhaps less informative. Therefore, increasing the PFR may increase the usefulness of the results",
			    placement: "right"

			  },
                  {
			    element: "#t",
			    title: "Top Hits",
			    content: "Sets the number of hits to return to the page",
			    placement: "right"

			  },
                  {
			    element: "#neg1",
			    title: "Negative Filtering",
			    content: "It is often useful to temporarily hide results from the results page. This decision is often made because a term is a false positive or a known true positive",
			    placement: "right"

			  },
                  {
			    element: "#share_option",
			    title: "Share Option",
			    content: "This button show the current share status of the results page. If this page is your own you can choose wether or not to share it by creating a unique link",
			    placement: "left"

			  },
                  {
			    element: "#concept_div",
			    title: "Concept Types",
			    content: "For the results on display, this section groups them by their type",
			    placement: "left"

			  },
                  {
			    element: "#reset_download",
			    title: "Download and Reset",
			    content: "Download the data on display in CSV format, or Reset the display to default values",
			    placement: "top"

			  },
                  {
			    element: "#results",
                      onShow: function(tour){$('.nav-tabs a[href="#home"]').tab('show');},
			    title: "Shared data",
			    content: "Details of the shared SemMed data",
			    placement: "top"

			  },
                  {
			    element: "#results",
                      onShow: function(tour){$('.nav-tabs a[href="#menu1"]').tab('show');},
			    title: "{{ s1_name }} enrichment details",
			    content: "Details of the enrichment analysis for {{ s1_name }}",
			    placement: "top"

			  },
                        {
			    element: "#results",
                      onShow: function(tour){$('.nav-tabs a[href="#menu2"]').tab('show');},
			    title: "{{ s2_name }} enrichment details",
			    content: "Details of the enrichment analysis for {{ s2_name }}",
			    placement: "top"

			  },
			]});

            //localStorage.clear();
            // Initialize the tour
			tour.init();

			// Start the tour
			tour.start();

            $("#startTour").click(function(){
                console.log('restarting tour')
   				 tour.restart();
			})

            $("#mesh").slider({
                range: "max",
                min: 1,
                max: 20,
                value: 7,
                slide: function (event, ui) {
                        $("#meshLevel").val(ui.value);
                },
                stop: function (event, ui) {
                    table_all.draw()
                }
            });
            $("#meshLevel").val($("#mesh").slider("value"));

            $("#minOdds").slider({
                range: "max",
                min: 0,
                max: 100,
                value: 10,
                slide: function (event, ui) {
                    $("#min").val(ui.value);
                },
                stop: function (event, ui) {
                    table_all.draw()
                }
            });
            $("#min").val($("#minOdds").slider("value"));

            $("#maxP").slider({
                range: "max",
                min: 1,
                max: 50,
                value: 2,
                slide: function (event, ui) {
                    $("#max").val('1e-'+ui.value);
                },
                stop: function (event, ui) {
                    table_all.draw()
                }
            });
            $("#max").val("1e-" + $("#maxP").slider("value"))

            $("#topHits").slider({
                range: "max",
                min: 5,
                max: 200,
                value: 20,
                step: 5,
                slide: function (event, ui) {
                    $("#maxTop").val(ui.value);
                },
                stop: function (event, ui) {
                    $('#resAll').DataTable().page.len(ui.value).draw()
                }
            });
            $("#maxTop").val($("#topHits").slider("value"))

            //table_all.draw();

            var resID = {{ res }}
            console.log('resID: '+resID)
            var table_all = $('#resAll').DataTable({
                //"order": [[4, "asc"],[5,"desc"]],
                //"data": {{ overlap | safe }},
                "pageLength": 20,
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url":"{% url 'ajax_overlap' %}",
                    "data": function(d){
                        d.resID = resID
                        var sTerm = neg_searcher()
                        var nsTerm = JSON.stringify(sTerm[0])
                        var psTerm = JSON.stringify(sTerm[1])
                        d.t = 'semmed'
                        d.n=nsTerm
                        d.p=psTerm
                        d.pval=parseFloat($("#max").val())
                        d.odds=parseFloat($("#min").val())
                        //d.iDisplayLength=parseInt($("#maxTop").val())
                        //d.top=parseInt($("#maxTop").val())
                        d.pfr=parseInt($("#meshLevel").val())
                        //console.log(d)
                        $('#filt_results_n').val(d.n)
                        $('#filt_results_p').val(d.p)
                        $('#filt_results_pval').val(d.pval)
                        $('#filt_results_odds').val(d.odds)
                        $('#filt_results_pfr').val(d.pfr)
                    },
                },
                //oLanguage: {
                //    sProcessing: "<img src='static/browser/img/spiffygif_22x22.gif'>"
                //},
                /*
                //scrolling
                scrollY:        200,
                deferRender:    true,
                scroller:       true,
                scroller: {
                    loadingIndicator: true
                },
                */
                "order": [[5, "asc"]],
                //"searchDelay": 350,
                dom: 'Bfrtip',
                //lengthChange: false,
                "buttons": [
                    'copy', 'csv','excel','colvis'
                ],
                "drawCallback": function( oSettings ) {
                  console.log( 'DataTables has redrawn the table' );
                  //setTimeout( function () {
                    google.charts.setOnLoadCallback(drawChart);
                    res_header();
                    concepts();
                    $('[data-toggle="tooltip"]').tooltip()
                  //}, 500 );

                      //setTimeout( function () {
                        graph_data();
                        //}, 500 );

                    //}, 1000 );
                },
                "columnDefs": [
                 {
                     render: function ( data, type, row ) {
                         var s = data.split("||")
                        {% comment %}
                        if (s[0] == s[5]) {
                             d = '(REVERSE) <span class="sem_item" data-num="s1" style="color:green; cursor: pointer">' + s[3].split(":")[1] + '</span> || '
                             d += '<span class="sem_item" data-num="s2" style="color:blue; cursor: pointer" >' + s[4] + '</span> || '
                             d += '<span class="sem_item" data-num="s3" style="color:red; cursor: pointer">' + s[5] + '</span> || '
                             d += '<span class="sem_item" data-num="s4" style="color:blue; cursor: pointer">' + s[1] + '</span> || '
                             d += '<span class="sem_item" data-num="s5" style="color:orange; cursor: pointer" >' + s[2] + '</span>'
                         }else{
                             d = '<span class="sem_item" data-num="s1" style="color:green; cursor: pointer">' + s[0] + '</span> || '
                             d += '<span class="sem_item" data-num="s2" style="color:blue; cursor: pointer" >' + s[1] + '</span> || '
                             d += '<span class="sem_item" data-num="s3" style="color:red; cursor: pointer">' + s[2] + '</span> || '
                             d += '<span class="sem_item" data-num="s4" style="color:blue; cursor: pointer">' + s[4] + '</span> || '
                             d += '<span class="sem_item" data-num="s5" style="color:orange; cursor: pointer" >' + s[5] + '</span>'
                         }
                         {% endcomment %}
                         d = '<span class="sem_item" data-num="s1" style="color:green; cursor: pointer">' + s[0] + '</span> || '
                         d += '<span class="sem_item" data-num="s2" style="color:blue; cursor: pointer" >' + s[1] + '</span> || '
                         d += '<span class="sem_item" data-num="s3" style="color:red; cursor: pointer">' + s[2] + '</span> || '
                         d += '<span class="sem_item" data-num="s4" style="color:blue; cursor: pointer">' + s[4] + '</span> || '
                         d += '<span class="sem_item" data-num="s5" style="color:orange; cursor: pointer" >' + s[5] + '</span>'
                         return d
                     },
                     targets: 0
                 },
                 {
                     render: function ( data, type, row ) {
                         var d = data
                         var orientation = row[0].split("||")
                         if (orientation[0] == orientation[5]){
                             link = '_1'
                         }else{
                             link = '_0'
                         }
                         if (data != 0){
                             var url = '{% url "pubs" "1_1" %}'.replace('1_1',row[8]+link)
                             var d = '<a href="'+url+'" target=\"_blank\"">'+data+'</a>'
                         }
                         return d
                     },
                     targets: 1
                 },
                 {
                     render: function ( data, type, row ) {
                         var d = data
                         var orientation = row[0].split("||")
                         if (orientation[0] == orientation[5]){
                             link = '_0'
                         }else{
                             link = '_1'
                         }
                         if (data != 0){

                             var url = '{% url 'pubs' '1_1' %}'.replace('1_1',row[8]+link)
                             var d = '<a href="'+url+'" target=\"_blank\"">'+data+'</a>'
                         }
                         return d
                     },
                     targets: 2
                 },
                 {
                     render: function ( data, type, row ) {
                         var d = data
                         var orientation = row[0].split("||")
                         if (data != 0){
                             var url = '{% url 'pubs' '1_1' %}'.replace('1_1',row[8]+'_2')
                             var d = '<a href="'+url+'" target=\"_blank\"">'+data+'</a>'
                         }
                         return d
                     },
                     targets: 3
                 },
                 {
                    targets: 8,
                    visible: false
                 }
                ]
                // scrollY:        200,
                //    deferRender:    true,
                //    scroller:       true
            })

            //check for low number of total records and adjust pfr
            function dynamic_filter(){
                var info = table_all.page.info();
                console.log(info)
                console.log('total records: '+info.recordsTotal)
                if ((info.recordsTotal > 0 && info.recordsTotal <= 20)){
                    //pfr
                    $("#mesh").slider("value", 1);
                    $("#meshLevel").val(1);
                    //odds
                    $("#minOdds").slider("value", 0);
                    $("#min").val(0);
                    //pval
                    $("#maxP").slider("value",1);
                    $("#max").val("1e-"+1);
                }else if (info.recordsTotal > 1000){
                    //pfr
                    $("#mesh").slider("value", 10);
                    $("#meshLevel").val(10);
                    //pval
                    $("#maxP").slider("value",10);
                    $("#max").val("1e-"+10);
                     //odds
                    $("#minOdds").slider("value", 50);
                    $("#min").val(50);
                }else{
                    $("#mesh").slider("value", 7);
                    //pfr
                    $("#meshLevel").val(7);
                    //pval
                    $("#maxP").slider("value",8);
                    $("#max").val("1e-"+8);
                      //odds
                    $("#minOdds").slider("value", 10);
                    $("#min").val(10);
                }
                table_all.draw();
            }

            setTimeout( function () {
                dynamic_filter()
            }, 1000 );

            function res_header(){
                //set results header
                var info = table_all.page.info();
                console.log(info)
                $("#res_top").text($("#maxTop").val());
                $("#res_filt").text(info.recordsDisplay.toLocaleString());
                $("#res_all").text(info.recordsTotal.toLocaleString());
            }

            function getSortedKeys(obj) {
                var keys = []; for(var key in obj) keys.push(key);
                return keys.sort(function(b,a){return obj[a]-obj[b]});
            }

            function concepts(){
                var jsonData = table_all.ajax.json();
                console.log('Compiling concepts')
                //console.log(jsonData.data)
                d = jsonData.data
                var conceptLists = {}
                for (var i = 0; i < jsonData.data.length; i++) {
                    var cList = []
                    var sList = []
                    var s = jsonData.data[i][0].split("||")
                    m0 = s[0].match(/(.*?)\s\((.*?)\)$/)
                    m2 = s[2].match(/(.*?)\s\((.*?)\)$/)
                    m5 = s[5].match(/(.*?)\s\((.*?)\)$/)
                    sList.push(m0[1])
                    sList.push(m2[1])
                    sList.push(m5[1])
                    cList.push(m0[2])
                    cList.push(m2[2])
                    cList.push(m5[2])
                    for (var j = 0; j < 3; j++) {
                        //check for multiple concept IDs
                        //cSplit = c[j].split(',').forEach(function(c){
                        c = cList[j]
                            if (c in conceptLists) {
                                if (conceptLists[c].indexOf(sList[j]) < 0) {
                                    conceptLists[c].push(sList[j])
                                }
                            } else {
                                conceptLists[c] = [sList[j]]
                            }
                        //})
                    }
                }
                var conceptCounts = {}
                for (var c in conceptLists){
                    conceptCounts[c] = conceptLists[c].length
                }

                console.log(conceptCounts)

                //get full concept names
                var fullNames = {{ cDic | safe}}
                //console.log(fullNames)

                //clear checkboxes
                $("#concept_boxes").text('')
                var conceptCounts_sorted_keys = getSortedKeys(conceptCounts)
                //console.log(conceptCounts_sorted_keys)
                for (var i in conceptCounts_sorted_keys) {
                    var key = conceptCounts_sorted_keys[i]
                    var name = fullNames[key]
                    //console.log(key)
                    //console.log(conceptLists[key].join("<br>"))
                    var concept_info = '<ul>'
                    for (var l in conceptLists[key]){
                        concept_info += '<li>'+conceptLists[key][l]+'</li>'
                    }
                    concept_info += '</ul>'
                    //$("#concept_boxes").append('<label data-toggle="tooltip" data-placement="top" data-original-title="'+conceptLists[key].join("\n")+'"><input type="checkbox" name="myCheckbox" checked/> '+name+' ('+conceptCounts[key]+')</span><br>');
                    $("#concept_boxes").append('<span id='+key+'_header class="open_img" onclick="concept_div(\''+key+'\')" style="white-space: nowrap; overflow:auto;">'+conceptCounts[key]+' '+name+'('+key+')</span><br><div id='+key+' style="display:none; white-space: nowrap; overflow:auto;">'+concept_info+'</div>');
                }
            }

            function neg_searcher(){
                //console.log('neg_searcher')
                var nsTerm = {all:'',s1:'',s2:'',s3:'',s4:'',s5:''}
                var psTerm = {all:'',s1:'',s2:'',s3:'',s4:'',s5:''}
                var sCheck = false
                var fList = ''
                //var nVal = $('#neg_search' + n).val()
                for (var i = 1; i <= neg_search_num; i++) {
                    var v = $('#neg_search' + i).val()
                    if (v) {
                        var s = $('#neg_search_opt' + i).val()
                        var t = $('#text_search_type' + i).val()
                        console.log('Neg search - ' + i + ":" + v + ":" +s+ ":" +t)
                        //console.log('Search type = '+s)
                        if (v.length > 2) {
                            //deal with pipes in concepts
                            //v = v.replace("|","\|")
                            //console.log('v = '+v)
                            if (t == 'i') {
                                nsTerm[s] += v + '||'
                                //add terms to download list
                                fList += i + "\t" + v + "\t" + s + "\tNeg\n"
                            }else{
                                psTerm[s] += v + '||'
                                //add terms to download list
                                fList += i + "\t" + v + "\t" + s + "\tPos\n"
                            }
                        }
                        if (v.length > 0) {
                            var sCheck = true
                        }
                        if (v.length == 0) {
                            $('#neg_search_opt' + i).val('all')
                            $('#text_search_type' + i).val('r')
                        }
                    }
                }
                {% comment %}for (i in nsTerm) {
                    //console.log(i+':'+nsTerm[i])
                    var a = nsTerm[i]
                    if (a.length > 0) {
                        a = a.slice(0, -1);
                        nsTerm[i] = a
                    }
                }
                for (i in psTerm) {
                    //console.log(i+':'+psTerm[i])
                    var a = psTerm[i]
                    if (a.length > 0) {
                        a = a.slice(0, -1);
                        psTerm[i] = a
                    }
                }{% endcomment %}

                $('#fList').val(fList)

                //console.log(nsTerm)
                //console.log(psTerm)

                return [nsTerm,psTerm]

            }

            //check for click events on SemMed items
            $("body").on('click', ".sem_item", function(){
                var v = $(this).html()
                var n = $(this).data("num")
                for (i = 1; i <= neg_search_num; i++) {
                    vCheck = $('#neg_search' + i).val()
                    //console.log('Neg search - ' + i + ":" + vCheck)
                    //check if already added
                    o = $('#neg_search_opt'+i).val()
                    //console.log('n - '+n+' o '+o)
                    if (vCheck == v && n == o){
                        break
                    }
                    if (vCheck.length == 0){
                        //console.log("Adding to neg box "+i)
                        $('#neg_search' + i).val(v)
                        //change select value
                        $('#neg_search_opt'+i).val(n)
                        table_all.ajax.reload()
                        break
                    }
                }
            });

            var table_s1 = $('#resA').DataTable({
                "order": [[5, "asc"],[3,"desc"]],
                dom: 'Bfrtip',
                lengthChange: false,
                "deferRender": true,
                "buttons": [
                    'copy', 'csv','excel','colvis'
                ],
				"columnDefs": [
                    {
                        render: function ( data, type, row ) {
                            d = data.split(":")[0]
                            //d = '<span class="sem_item" style="color:green; cursor: pointer">'+s+'</span>'
                            return d
                        },
                        "targets": 0
                    },
					{
                        render: function ( data, type, row ) {
                            var [obs1,obs2] = data.split("/")
							var concept_id = row[0].split(':')[1]
							var resID = '{{res}}'
							var url = '{% url 'pubss' '1_1_1' %}'.replace('1_1_1',concept_id+'_'+resID+'_1')
							var d = '<a href="'+url+'" target=\"_blank\"">'+obs1+'</a>/'+obs2
                            return d
                        },
                        "targets": 1
                    },
				]
            })
            var table_s2 = $('#resB').DataTable({
                "order": [[5, "asc"],[3,"desc"]],
                dom: 'Bfrtip',
                lengthChange: false,
                "deferRender": true,
                "buttons": [
                    'copy', 'csv','excel','colvis'
                ],
				"columnDefs": [
                    {
                        render: function ( data, type, row ) {
                            d = data.split(":")[0]
                            //d = '<span class="sem_item" style="color:green; cursor: pointer">'+s+'</span>'
                            return d
                        },
                        "targets": 0
                    },
					{
                        render: function ( data, type, row ) {
                            var [obs1,obs2] = data.split("/")
							var concept_id = row[0].split(':')[1]
							var resID = '{{res}}'
							var url = '{% url 'pubss' '1_1_1' %}'.replace('1_1_1',concept_id+'_'+resID+'_2')
							var d = '<a href="'+url+'" target=\"_blank\"">'+obs1+'</a>/'+obs2
                            return d
                        },
                        "targets": 1
                    },
				]
            })

             var oTable = $('#datatable').dataTable({
                // ...
                "processing": true,
                "serverSide": true,
                "ajax": "{% url 'order_list_json' %}"
            });

            //setInterval( function () {
            //    table.ajax.reload();
            //}, 5000 );



            google.charts.load("45", {packages: ["sankey"]});
            //google.charts.setOnLoadCallback(drawChart);
            function drawChart() {
                console.log('drawing chart with '+$("#maxTop").val()+' values')
                //get the data from used for the table
                var jsonData = table_all.ajax.json();
                console.log(jsonData.data.length+' rows were loaded')
                //console.log(jsonData.data)

                var data = new google.visualization.DataTable();
                var s1Name = '{{ s1_name }}'
                var s2Name = '{{ s2_name }}'
                var sData = []
                var maxCounter = 0
                //var r = table_all.$('tr', {"filter":"applied"}).each( function ( value, index ) {
                //redundant data going in, need to stop this
                var rCheck = []
                for (var i = 0; i < jsonData.data.length; i++) {
                    d = jsonData.data[i]
                    maxCounter += 1
                    //mt = index.cells[0].innerHTML
                    var mt = d[0]
                    //console.log(mt)
                    ss1_sub = mt.split("||")[0]
                    ss1_pred = mt.split("||")[1]
                    ss_overlap = mt.split("||")[2]
                    ss2_pred = mt.split("||")[4]
                    ss2_obj = mt.split("||")[5]
                    exp_score = d[1]
                    out_score = d[2]

                    if (maxCounter < $("#maxTop").val()){
                        //sData.push([s1Name,ss1_sub+'['+ss1_pred+']',parseInt(exp_score)])
                        //sData.push([ss1_sub+'['+ss1_pred+']','o:'+ss_overlap,parseInt(exp_score)])
                        //sData.push(['o:'+ss_overlap,ss2_obj+'['+ss2_pred+']',parseInt(out_score)])
                        //sData.push([ss2_obj+'['+ss2_pred+']',s2Name,parseInt(out_score)])

                        //sData.push([s1Name,ss1_sub+' ['+ss1_pred+']',parseInt(exp_score)])
                        if (rCheck.indexOf(ss1_sub+'_'+ss1_pred+'_'+ss_overlap) === -1) {
                            sData.push([ss1_sub + ' [' + ss1_pred + ']', ss_overlap, parseInt(exp_score)])
                            rCheck.push(ss1_sub+'_'+ss1_pred+'_'+ss_overlap)
                        }
                        if (rCheck.indexOf(ss_overlap+'_'+ss2_pred+'_'+ss2_obj) === -1) {
                            sData.push([ss_overlap,'['+ss2_pred+'] '+ss2_obj,parseInt(out_score)])
                            rCheck.push(ss_overlap+'_'+ss2_pred+'_'+ss2_obj)
                        }

                        //sData.push(['['+ss2_pred+'] '+ss2_obj,s2Name,parseInt(out_score)])
                    }
                    //console.log(sData)
                }
                //console.log(sData)
                data.addColumn('string', 'From');
                data.addColumn('string', 'To');
                data.addColumn('number', 'Articles');
                data.addRows(sData)

                // Set chart options
                var options = {
                    width: $("#graph_div").width()-30,
                    height: 500,

                    //iterations: 100,
                    //sankey: { node: { nodePadding: 10 } },
                    sankey: {
                        node: {
                            interactivity: true
                        }
                    }
                };

                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.Sankey(document.getElementById('sankey_multiple'));
                chart.draw(data, options);

                google.visualization.events.addListener(chart, 'select', function() {
                    var sel = chart.getSelection();
                    //console.log(sel[0])
                    val=sel[0].name.replace(/ *\[[^)]*\] */g, "");
                    tFilter(val)
                    //if (sel.length)
                    //    console.log('You selected node "' + sel[0].name + '"');
                });
            }

            function d3_graph(graph){
                var width = $("#graph_div").width()-30,
                    height = 500,
                    radius = 6;
                console.log(width,height,radius)
                var force = d3.layout.force()
                        .size([width, height])
                        .charge(-3000)
                        .linkDistance(40)
                        .on("tick", tick)
                        .nodes(graph.nodes)
                        .links(graph.links)
                        .start();

                var drag = force.drag()
                        .on("dragstart", dragstart);

                //remove svg for redraw - should really do this the proper way but hey ho :)
                d3.select("svg").remove();
                var svg = d3.select("#graph")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);
                /*
                svg.append("svg:defs").selectAll("marker")
                    .data(["end"])      // Different link/path types can be defined here
                  .enter().append("svg:marker")    // This section adds in the arrows
                    .attr("id", String)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", -1.5)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("svg:path")
                    .attr("d", "M0,-5L10,0L0,5");
                */
                //remove previous data for reloads (not the correct way of doing this!!!)
                //svg.selectAll(".link").remove();
                //svg.selectAll(".node").remove();

                var link = svg.selectAll(".link")
                        .data(graph.links)
                        .enter().append("line")
                        .attr("class", "link")
                        .style("stroke-width", function (d) {
                            //return d.value / 5;
                            //return Math.sqrt(d.value)-0.5;
                            return d.value;
                        })
                        .style("stroke", function (d) {
                            return d.color;
                        })
                        //.attr("marker-end", "url(#end)");


                var node = svg.selectAll(".node")
                        .data(graph.nodes)
                        .enter().append("g")
                        .attr("class", "node")
                        .on("dblclick", dblclick)
                        .call(drag);

                node.append("circle")
                        .attr("r", function (d) {
                            return d.size * 3;
                        })
                        .style("fill", function (d) {
                            return d.color;
                        })
                        .style("stroke",'#000')

                node.append("text")
                        .attr("dx", 12)
                        .attr("dy", ".35em")
                        .text(function (d) {
                            return d.label
                        })
                //.style("font-size","12px")
                //.style("font-family","trebuchet")

                function tick() {
                    link.attr("x1", function (d) {
                                return d.source.x;
                            })
                            .attr("y1", function (d) {
                                return d.source.y;
                            })
                            .attr("x2", function (d) {
                                return d.target.x;
                            })
                            .attr("y2", function (d) {
                                return d.target.y;
                            });

                    node.attr("cx", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x)); })
                        .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); })

                        //for the g element
                        .attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });
                }

                function dblclick(d) {
                    //d3.select(this).style("stroke",'#000')
                    d3.select(this).classed("fixed", d.fixed = false);
                }

                function dragstart(d) {
                    //d3.select(this).style("stroke",'#FFF')
                    d3.select(this).classed("fixed", d.fixed = true);
                }
            }
            //graph_data()
            //var graph = graph_data()
            //var d = d3_graph(graph)

        function graph_data() {
            var i, v, s, g = {nodes: [], links: []};
            var nodeCheck = []
            var relCheck = []
            var ssCheck = false
            var nCount = 0
            console.log('getting graph data')
            var s1Name = '{{ s1_name }}'.trim()
            var s2Name = '{{ s2_name }}'.trim()
            //add search set nodes
            g.nodes.push({
                name: 0,
                label: 'SS:'+s1Name,
                size: 3,
                color: 'blue'
            });
            g.nodes.push({
                name: 1,
                label: 'SS:'+s2Name,
                size: 3,
                color: 'blue'
            });
            nodeCheck.push('SS:'+s1Name, 'SS:'+s2Name)
            nCount = 2

            var sData = []
            var maxCounter = 0
            var linkLimits = [1000000,0]
            var jsonData = table_all.ajax.json();
            for (var i = 0; i < jsonData.data.length; i++) {
                d = jsonData.data[i]
                maxCounter += 1
                //mt = index.cells[0].innerHTML
                var mt = d[0]
                //var st = d[9]
                ss1_sub = mt.split("||")[0]
                ss1_pred = mt.split("||")[1]
                ss_overlap = mt.split("||")[2]
                ss2_pred = mt.split("||")[4]
                ss2_obj = mt.split("||")[5]
                exp_score = d[1]
                out_score = d[2]

                if (maxCounter < $("#maxTop").val()) {
                     //get min and max link values for adjustment
                    if (exp_score < linkLimits[0]){linkLimits[0] = exp_score}
                    if (out_score < linkLimits[0]){linkLimits[0] = out_score}
                    if (exp_score > linkLimits[1]){linkLimits[1] = exp_score}
                    if (out_score > linkLimits[1]){linkLimits[1] = out_score}

                    //add nodes
                    if (nodeCheck.indexOf(ss1_sub) < 0) {
                        g.nodes.push({
                            name: nCount,
                            label: ss1_sub,
                            size: 2,
                            color: '#ccc'
                        });
                        nodeCheck.push(ss1_sub)
                        nCount++
                    }
                    if (nodeCheck.indexOf(ss_overlap) < 0) {
                        g.nodes.push({
                            name: nCount,
                            label: ss_overlap,
                            size: 2,
                            color: '#ccc'
                        });
                        nodeCheck.push(ss_overlap)
                        nCount++
                    }
                    if (nodeCheck.indexOf(ss2_obj) < 0) {
                        g.nodes.push({
                            name: nCount,
                            label: ss2_obj,
                            size: 2,
                            color: '#ccc'
                        });
                        nodeCheck.push(ss2_obj)
                        nCount++
                    }

                    //add links for search set to subject
                    if (relCheck.indexOf('SS:'+s1Name + ":" + ss1_sub) < 0) {
                        g.links.push({
                            source: nodeCheck.indexOf('SS:'+s1Name),
                            target: nodeCheck.indexOf(ss1_sub),
                            value: exp_score,
                            color: 'green',
                            id: s1Name + ":" + ss1_sub
                        });
                        relCheck.push('SS:'+s1Name + ":" + ss1_sub)
                    }

                    if (relCheck.indexOf('SS:'+s2Name + ":" + ss2_obj) < 0) {
                        g.links.push({
                            source: nodeCheck.indexOf('SS:'+s2Name),
                            target: nodeCheck.indexOf(ss2_obj),
                            value: out_score,
                            color: 'orange',
                            id: 'SS:'+s2Name + ":" + ss2_obj
                        });
                        relCheck.push('SS:'+s2Name + ":" + ss2_obj)
                    }
                    //add links for subject to overlapping object
                    if (relCheck.indexOf(ss1_sub + ":" + ss_overlap) < 0) {
                        g.links.push({
                            source: nodeCheck.indexOf(ss1_sub),
                            target: nodeCheck.indexOf(ss_overlap),
                            value: exp_score,
                            label: ss1_pred,
                            id: ss1_sub + ":" + ss_overlap
                        });
                        relCheck.push(ss1_sub + ":" + ss_overlap)
                    }

                    if (relCheck.indexOf(ss2_obj + ":" + ss_overlap) < 0) {
                        g.links.push({
                            source: nodeCheck.indexOf(ss2_obj),
                            target: nodeCheck.indexOf(ss_overlap),
                            value: out_score,
                            label: ss2_pred,
                            id: ss2_obj + ":" + ss_overlap
                        });
                        relCheck.push(ss2_obj + ":" + ss_overlap)
                    }
                }
            }
            //adjust link values
            maxLinkSize = 10
            //console.log('linkLimits:'+linkLimits)
            linkSpan = linkLimits[1]
            //console.log('linkSpan:'+linkSpan)
            linkAdjust = linkSpan/maxLinkSize
            //console.log('linkAdjust:'+linkAdjust)
            g.links = g.links.filter(function (link) {
                link.value = link.value / linkAdjust
                return link
            })
            console.log(g)
            //console.log(nodeCheck)
            //return g
            d3_graph(g)
            //var graph = g
        }


        //reset button
        $(".reset_btn").click(function() {
            console.log('Resetting')

            //clear search field
            tFilter('')

            //reset sliders
            dynamic_filter()
            //$("#minOdds").slider("value", 10);
            //$("#min").val(10);
            //$("#maxP").slider("value", 3);
            //$("#max").val('1e-' + 3);

            //reset top number
            $("#maxTop").val(20);
            $("#topHits").slider("value", 20);

            //remove ignore options
            $('.neg_search_box').val('')
            $('.neg_search_opt').val('s1')
            $('.search_opt_type').val('i')
            table_all.ajax.reload()
        })
            show_share_button('{{ shareStatus }}')

            $("#success-alert").hide();
            $("#share_button_no").click(function () {
                $("#success-alert").alert();
                $("#success-alert").fadeTo(20000, 500).slideUp(500, function(){
                $("#success-alert").slideUp(500);
                });
            });
            $("#share_button_yes").click(function () {
               $("#success-alert").hide()
            });

           {% comment %}
           $('#download').click(function() {
                console.log('downloading...')
                $.ajax({
                    url: "{% url 'download_result' %}",
                    method: 'GET', // or another (GET), whatever you need
                    data: {
                        resID: {{ res }}, // data you need to pass to your function
                    },
                    success: function (data) {
                        // success callback
                        // you can process data returned by function from views.py
                    }
                });
            });
            {% endcomment %}
            var filter_html = ''
            for (i = 1; i < neg_search_num+1; i++) {
                filter_html += '<form class="form-inline"><div class="form-group"><input type="text" id="neg_search'+i+'" size="8" class="form-control input-sm neg_search_box"> <select id="neg_search_opt'+i+'"  class="form-control input-sm neg_search_opt"  style="width: 35px;padding-left:0px;padding-right:0px""> <option value="s1">1</option> <option value="s2">2</option> <option value="s3">3</option> <option value="s4">4</option> <option value="s5">5</option> </select> <select id="text_search_type'+i+'"  class="form-control input-sm search_opt_type" style="width: 35px;padding-left:0px;padding-right:0px""> <option value="i">N</option> <option value="r">Y</option> </select> </div></form>'
            }
            //console.log(filter_html)
            $('#filter_boxes').html(filter_html)

            //handlers for text insert and option change
            $('.neg_search_opt').on('change', function(){table_all.ajax.reload()});
            $('.search_opt_type').on('change', function(){table_all.ajax.reload()});
            $('.neg_search_box').on('keyup', function(){if ($('#neg_search1').val().length>2 || $('#neg_search1').val().length==0){table_all.ajax.reload()}});

        $('#fFile').change(function() {
           $('#upload_filter_form').submit();

        });

        $('#filter_save').click(function(){
            var sTerm = neg_searcher()
            var nsTerm = JSON.stringify(sTerm[0])
            var psTerm = JSON.stringify(sTerm[1])
            console.log('saving filters')
            $.ajax({
                url: "{% url 'save_filter' %}",
                "data": {
                    resID : resID,
                    type : 'st',
                    nsTerm : nsTerm,
                    psTerm : psTerm
                },
                type: 'get', // This is the default though, you don't actually need to always mention it
                success: function(data) {
                    //update button
                },
                failure: function(data) {
                    alert('Got an error dude');
                }
            });
        })

        });

    //function to submit filter list for download if not empty
    function fList_submit() {
        console.log('fList_submit')
        var f = document.getElementById('fList').value;
        if (f.length>0) {
            console.log(f);
            document.getElementById('filter_form').submit();
        }
    }
    </script>
{% endblock %}

{% block title %}Results{% endblock %}

{% block content %}
    {% if overlap > 0 %}
        <div class="row">
            <div class="col-lg-2" id="graph_sliders">
                <br><br><br>
                <div id="p">
                    <label for="max" data-toggle="tooltip" title="Maximum mean corrected P-Value for the enrichment analysis across both search sets"><small>Max Cor PVal:</small></label>
                    <input type="text" id="max" readonly style="border:0; color:#f6931f; font-weight:bold;" size="5">
                    <div id="maxP"></div>
                </div>
                <br>
                <div id="o">
                    <label for="min" data-toggle="tooltip" title="Minimum mean odds ratio for the enrichment analysis across both search set"><small>Min Odds:</small></label>
                    <input type="text" id="min" readonly style="border:0; color:#f6931f; font-weight:bold;" size="5">
                    <div id="minOdds"></div>
                </div>
                <br>
                <div id="m">
                    <label for="meshLevel" data-toggle="tooltip" title="Each of the SemMedDB predicates (the linking term) has a frequency value, calculated using the entire data set. Predicates with high frequency, such as 'ISA' and 'PART_OF' are often highly frequent and perhaps less informative. Therefore, increasing the PFR may increase the usefulness of the results"><small>Min PFR:</small></label>
                    <input type="text" id="meshLevel" readonly style="border:0; color:#f6931f; font-weight:bold;" size="5">
                    <div id="mesh"></div>
                </div>
                <br>
                <div id="t">
                    <label for="maxTop" data-toggle="tooltip" title="The number of top hits to display in the charts and table"><small>Top Hits:</small></label>
                    <input type="text" id="maxTop" readonly style="border:0; color:#f6931f; font-weight:bold;" size="5">
                    <div id="topHits"></div>
                </div>
                <br>
                <div id="neg1" style="overflow-y: scroll; height: 280px" >
                    <form id="filter_form" action="{% url  'download_filter' %}" method="post" style=" display:inline;margin:0px;padding:0px;">{% csrf_token %}
                             <label><small>Filter: <a href="javascript:void(0);" onclick="fList_submit();">(Download List)</a></small></label>
                         <input type="hidden" name="fList" id="fList" value=''>
                         <input type="hidden" name="resID" id="fList_resID" value={{ res }}>
                         <input type="hidden" name="fType" id="fType" value="semmed_t">
                     </form>
                   {% comment %}     <button type="submit" class="btn btn-info download_btn" id="filter_save">
                            <span class="glyphicon glyphicon-floppy-save" aria-hidden="true" id="download"></span>&nbsp;
                            <span>Save</span>
                        </button>{% endcomment %}
                    <label for="neg_search1">
                    <div id="filter_boxes"></div>
                </div>
                {% comment %}<form id="upload_filter_form" action="{% url  'upload_filter' %}" method="post" style=" display:inline;margin:0px;padding:0px;" enctype="multipart/form-data">{% csrf_token %}
                         <input type="file" name="fFile" id="fFile" value=''>
                         <input type="hidden" name="resID" id="fList_resID" value={{ res }}>
                         <input type="hidden" name="fType" id="fType" value="semmed_t">
                     </form>{% endcomment %}
            </div>
            <div class="col-lg-8" id="plots">
                <div class="alert alert-success" id="success-alert" style="display: none">
                    <button type="button" class="close" data-dismiss="alert">x</button>
                    Results available via this link - <a href="http://melodi.biocompute.org.uk/results/{{ hash_id }}/">http://melodi.biocompute.org.uk/results/{{ hash_id }}/</a>.
                </div>

                <div id="res_header" style="position: relative; left: 270px; top: 33px">
                    Showing top <span id="res_top"></span> of <span id="res_filt"></span> filtered results (total : <span id ="res_all"></span>)
                </div>
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#graph_div">Graph</a></li>
                    <li><a data-toggle="tab" href="#sankey_div">Sankey Plot</a></li>
                </ul>

                <div class="tab-content">
                    <div id="graph_div" class="tab-pane fade in active">
                        <div id="graph" style="margin: auto; width:100%; height: 500px;"></div>
                    </div>
                    <div id="sankey_div" style="width:100%;" class="tab-pane fade">
                        <div id="sankey">
                            <div style="margin: auto; width:100%; height: 500px;" id="sankey_multiple"></div>
                        </div>
                    </div>
                    <div style="text-align: center;" id="reset_download">
                        <form action="{% url  'download_result' %}" method="post" style=" display:inline;margin:0px;padding:0px;">{% csrf_token %}
                            <button type="submit" class="btn btn-info download_btn" name="download_res" value="filt">
                                <span class="glyphicon glyphicon-download-alt" aria-hidden="true" id="download"></span>&nbsp;
                                <span>Filtered</span>
                            </button>
                            <button type="submit" class="btn btn-info download_btn" name="download_res" value="all">
                                <span class="glyphicon glyphicon-download-alt" aria-hidden="true" id="download"></span>&nbsp;
                                <span>All</span>
                            </button>
                            <input type="hidden" name="resID" id="resID" value={{ res }}>
                            <input type="hidden" name="type" id="type" value='st'>
                            <input type="hidden" name="filt_results_n" id="filt_results_n" value=''>
                            <input type="hidden" name="filt_results_p" id="filt_results_p" value=''>
                            <input type="hidden" name="filt_results_pval" id="filt_results_pval" value=''>
                            <input type="hidden" name="filt_results_odds" id="filt_results_odds" value=''>
                            <input type="hidden" name="filt_results_pfr" id="filt_results_pfr" value=''>
                        </form>
                        <button type="button" class="btn btn-info reset_btn">
                            <span class="glyphicon glyphicon-refresh" aria-hidden="true" id="reset"></span>&nbsp;
                            <span>Reset</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-2">
            <br>
            <div id="share_option">
                {% if userStatus == 'user' %}
                        <div id ="share_yes" style="display:none;">
                            <button type="button" id='share_button_yes' class="btn btn-success" aria-label="Left Align" onclick="share_result('{{ hash_id }}','False');">
                                <span class="glyphicon glyphicon-share-alt" aria-hidden="true" id="shareText"></span>&nbsp;
                                <span id="shareText">Shared <small>(Click to unshare)</small></span>
                            </button>
                        </div>
                         <div id ="share_no">
                            <button type="button" id='share_button_no' class="btn btn-success" aria-label="Left Align" onclick="share_result('{{ hash_id }}','True');">
                                <span class="glyphicon glyphicon-share-alt" aria-hidden="true" id="shareText"></span>&nbsp;
                                <span>Share result</span>
                            </button>
                        </div>
                {%  elif userStatus == 'guest' %}
                    <button id='share_button' class="btn btn-success" style="cursor:not-allowed"><span id="shareText">Result is shared</span></button>
                {% endif %}
            </div>
                <br>
            <div id ="concept_div">
                <h5>Concepts: (<a href="https://raw.githubusercontent.com/mengjunxie/ae-lda/master/misc/SRDEF.txt">types</a>)</h5>
                <div id="concept_boxes" style="height: 500px; overflow: scroll;">>
                </div>
            </div>
            </div>
        </div>

    {% else %}
        <h3>No overlapping data were identified.</h3>
    {% endif %}
<div id="results">
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#home">Overlap</a></li>
        <li><a data-toggle="tab" href="#menu1">{{ s1_name |truncatechars:20 }} {% if year2 != 2016 %} ({{ year2 }}){%  endif %}</a></li>
        <li><a data-toggle="tab" href="#menu2">{{ s2_name |truncatechars:20 }} {% if year2 != 2016 %} ({{ year2 }}){%  endif %}</a></li>
    </ul>
    <div class="tab-content">
        <div id="home" class="tab-pane fade in active">
            <table id="resAll" class="display" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>Overlapping Semantic MEDLINE Objects</th>
                    <th>{{ s1_name|truncatechars:10 }}</th>
                    <th>{{ s2_name|truncatechars:10 }}</th>
                    <th>Shared</th>
                    <th>Score</th>
                    <th width="10%">Mean CP</th>
                    <th>Mean Odds</th>
                    <th>Min PFR</th>
                </tr>
                </thead>

                <tbody>
                </tbody>

            </table>
        </div>
        <div id="menu1" class="tab-pane fade">
            <table id="resA" class="display" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>SemMedDB</th>
                    <th>Observed</th>
                    <th>Expected</th>
                    <th>Odds Ratio</th>
                    <th>P-value</th>
                    <th>Corrected P-value</th>
                </tr>
                </thead>
                <tbody>
                {% for a in resA %}
                    <tr>
                        <td>{{ a }}</td>
                        {% for i in resA|get_item:a %}
                            <td>{{ i }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="menu2" class="tab-pane fade">
            <table id="resB" class="display" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>SemMedDB</th>
                    <th>Observed</th>
                    <th>Expected</th>
                    <th>Odds Ratio</th>
                    <th>P-value</th>
                    <th>Corrected P-value</th>
                </tr>
                </thead>
                <tbody>
                {% for a in resB %}
                    <tr>
                        <td>{{ a }}</td>
                        {% for i in resB|get_item:a %}
                            <td>{{ i }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}
